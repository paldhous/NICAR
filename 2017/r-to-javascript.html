<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Peter Aldhous | NICAR 2017</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="../css/bootstrap.min.css" rel="stylesheet"> 
  <link href="../css/custom.css" rel="stylesheet">
</head>

<body class="markdown github">

	<header class="navbar-inverse navbar-fixed-top">
		<div class="container">
			<nav role="navigation">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a href="index.html" class="navbar-brand">NICAR 2017</a>
				</div> <!-- /.navbar-header -->
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
					<ul class="nav navbar-nav">
						<li class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown">Session notes<b class="caret"></b></a>
							<ul class="dropdown-menu">
								<li><a href="r-analysis.html">Data analysis in R</a></li>
								<li><a href="r-to-javascript.html">Javascript charts and maps, straight from R</a></li>
							</ul>
						</li>
						<li>
						<li>
						<li><a href="software.html">Software</a></li>
						<li><a href="datasets.html">Data</a></li>	
						<li><a href="mailto:peter@peteraldhous.com">Contact</a></li>
					</ul>
				</div><!-- /.navbar-collapse -->
			</nav>
		</div> <!-- /.navbar-header -->
	</header>

	<div class="container all">

<h1 id="from-r-to-interactive-charts-and-maps"><a name="from-r-to-interactive-charts-and-maps" href="#from-r-to-interactive-charts-and-maps"></a>From R to interactive charts and maps</h1><p>It is possible to make JavaScript visualizations directly from R/RStudio, thanks to a group of packages collectively known as <a href="http://www.htmlwidgets.org/"><strong>htmlwidgets</strong></a>.</p><p>These packages take instructions in R code, and write the JavaScript and HTML necessary to draw charts using JavaScript visualization libraries. They allow you to easily export the charts you create in R as web pages, which can be embedded in other projects through simple <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe">iframes</a>.</p><p>This means that you can work in a single environment to both process data and make online charts. Maintaining a simple, streamlined workflow makes it easier to produce graphics quickly on news deadlines.</p><h3 id="the-data-we-will-use-today"><a name="the-data-we-will-use-today" href="#the-data-we-will-use-today"></a>The data we will use today</h3><p>Download the data for this session from <a href="data/r-to-javascript.zip">here</a> and unzip the folder. This data should already be loaded on the machines at the NICAR meeting:</p><h5 id="health-and-wealth-of-nations"><a name="health-and-wealth-of-nations" href="#health-and-wealth-of-nations"></a>Health and wealth of nations</h5><ul>
<li><code>nations.csv</code> Data from the <a href="http://data.worldbank.org/indicator/?tab=all">World Bank Indicators</a> portal. Contains the following fields:<ul>
<li><code>iso2c</code> <code>iso3c</code> Two- and Three-letter <a href="http://www.nationsonline.org/oneworld/country_code_list.htm">codes</a> for each country, assigned by the <a href="http://www.iso.org/iso/home/store/catalogue_tc/catalogue_detail.htm?csnumber=63545">International Organization for Standardization</a>.</li><li><code>country</code> Country name.</li><li><code>year</code> From 1990 to 2015.</li><li><code>population</code> Estimated <a href="http://data.worldbank.org/indicator/SP.POP.TOTL">total population</a> at mid-year, including all residents apart from refugees.</li><li><code>life_expect</code> <a href="http://data.worldbank.org/indicator/SP.DYN.LE00.IN">Life expectancy at birth</a>, in years.</li><li><code>population</code> Estimated <a href="http://data.worldbank.org/indicator/SP.POP.TOTL">total population</a> at mid-year, including all residents apart from refugees.</li><li><code>birth_rate</code> <a href="http://data.worldbank.org/indicator/SP.DYN.CBRT.IN">Live births during the year per 1,000 people</a>, based on mid-year population estimate.</li><li><code>neonat_mortal_rate</code> <a href="http://data.worldbank.org/indicator/SH.DYN.NMRT">Neonatal mortality rate</a>: babies dying before reaching 28 days of age, per 1,000 live births in a given year.</li><li><code>region</code> <code>income</code> World Bank <a href="http://siteresources.worldbank.org/DATASTATISTICS/Resources/CLASS.XLS">regions and income groups</a>, explained <a href="http://data.worldbank.org/about/country-and-lending-groups">here</a>.</li><li><code>gdp_percap</code> <a href="http://data.worldbank.org/indicator/NY.GDP.PCAP.PP.CD">Gross Domestic Product per capita</a> in current international dollars, corrected for purchasing power in different territories.</li></ul>
</li></ul><h5 id="us-seismic-risk"><a name="us-seismic-risk" href="#us-seismic-risk"></a>US seismic risk</h5><ul>
<li><code>seismic_risk_clip</code> Folder containing this <a href="http://earthquake.usgs.gov/hazards/products/conterminous/index.php#2014">U.S. Geological Survey shapefile</a>, detailing the risk of experiencing a major earthquake, clipped to the boundaries of the continental United States.</li></ul><h3 id="reproducibility:-save-your-scripts"><a name="reproducibility:-save-your-scripts" href="#reproducibility:-save-your-scripts"></a>Reproducibility: Save your scripts</h3><p>Data journalism should ideally be fully documented and reproducible. R makes this easy, as every operation performed can be saved in a script, and repeated by running that script. Click on the <img src="img/r_1.jpg" alt=""> icon at top left and select <code>R Script</code>. A new panel should now open:</p><p><img src="img/r_2.jpg" alt=""></p><p>Any code we type in here can be run in the console. Hitting <code>Run</code> will run the line of code on which the cursor is sitting. To run multiple lines of code, highlight them and click <code>Run</code>.</p><p>Click on the save/disk icon in the script panel and save the blank script to the folder on your desktop continaing the data for this class, calling it <code>r-to-javascript.R</code>.</p><h3 id="set-your-working-directory"><a name="set-your-working-directory" href="#set-your-working-directory"></a>Set your working directory</h3><p>Now we can set the working directory to this folder by selecting from the top menu <code>Session&gt;Set Working Directory&gt;To Source File Location</code>. (Doing so means we can load the files in this directory without having to refer to the full path for their location, and anything we save will be written to this folder.)</p><h3 id="save-your-data"><a name="save-your-data" href="#save-your-data"></a>Save your data</h3><p>The panel at top right has two tabs, the first showing the <code>Environment</code>, or all of the “objects” loaded into memory for this R session. We can save this as well, so we don’t have to load and process data again if we return to return to a project later.</p><p>(The second tab shows the <code>History</code> of the operations you have performed in RStudio.)</p><p>Click on the save/disk icon in the <code>Environment</code> panel to save and call the file <code>r-analysis.RData</code>.</p><h4 id="load-htmlwidgets-and-other-required-packages"><a name="load-htmlwidgets-and-other-required-packages" href="#load-htmlwidgets-and-other-required-packages"></a>Load htmlwidgets and other required packages</h4><p>In this class, we will work with the following packages:</p><ul>
<li><strong><a href="https://cran.r-project.org/web/packages/readr/readr.pdf">readr</a></strong> For reading and writing CSV and other text files.</li><li><strong><a href="https://cran.r-project.org/web/packages/dplyr/dplyr.pdf">dplyr</a></strong> For processing and manipulating data.</li><li><strong><a href="">htmlwidgets</a></strong> To export Javascript visualizations as standalone web pages.</li><li><a href="http://jkunst.com/highcharter/index.html"><strong>highcharter</strong></a> is a package within the htmlwidgets framework that connects R to the <a href="http://www.highcharts.com/">Highcharts</a> and <a href="http://www.highcharts.com/products/highstock">Highstock</a> JavaScript charting libraries. These are free for non-commercial use, but require <a href="https://shop.highsoft.com/highcharts/?utm_expid=116444199-8.wmOnFKwGTY-LUbcbVjWH6g.0&amp;utm_referrer=https%3A%2F%2Fshop.highsoft.com%2Fhighstock#HC-DEV-1">paid</a> <a href="https://shop.highsoft.com/highstock">licenses</a> for commercial projects.</li><li><strong><a href="https://cran.r-project.org/web/packages/RColorBrewer/RColorBrewer.pdf">RColorBrewer</a></strong> To use <a href="http://colorbrewer2.org/">ColorBrewer</a> palettes.</li><li><strong><a href="http://rstudio.github.io/leaflet/">leaflet</a></strong> An htmlwidget that connects R to the <a href="http://leafletjs.com/">Leaflet</a> JavaScript mapping library.</li><li><strong><a href="https://cran.r-project.org/web/packages/rgdal/rgdal.pdf">rgdal</a></strong>, To load shapefiles and other geodata into R.</li><li><strong><a href="http://rstudio.github.io/dygraphs/">dygraphs</a></strong> An htmlwidget that connects R to the <a href="http://dygraphs.com/">dygraphs</a> JavaScript charting library, optimized for drawing time series charts.</li><li><strong><a href="https://cran.r-project.org/web/packages/quantmod/quantmod.pdf">quantmod</a></strong> To download stock market data.</li><li><strong><a href="http://rstudio.github.io/DT/">DT</a></strong> An htmlwidget that connects R to <a href="https://datatables.net/">DataTables</a>, a plugin for <a href="https://jquery.com/">jQuery</a> that makes interactive HTML tables.</li></ul><p>To install a package, click on the <code>Install</code> icon in the <code>Packages</code> tab, type its name into the dialog box, and make sure that <code>Install dependencies</code> is checked, as some packages will only run correctly if other packages are also installed. Click <code>Install</code> and all of the required packages should install.</p><p>Each time you start R, it’s a good idea to click on <code>Update</code> in the <code>Packages</code> panel to update all your installed packages to the latest versions.</p><p>Installing a package makes it available to you, but to use it in any R session you need to load it. You can do this by checking its box in the <code>Packages</code> tab. However, we will load packages with the following code. Copy the code into your script, highlight, and <code>Run</code>:</p><pre class="r hljs"><code class="r" data-origin="<pre><code class=&quot;r&quot;># load required packages
library(readr)
library(dplyr)
library(htmlwidgets)
library(highcharter)
library(RColorBrewer)
library(leaflet)
library(rgdal)
library(dygraphs)
library(quantmod)
library(DT)
</code></pre>"><span class="hljs-comment"># load required packages</span>
<span class="hljs-keyword">library</span>(readr)
<span class="hljs-keyword">library</span>(dplyr)
<span class="hljs-keyword">library</span>(htmlwidgets)
<span class="hljs-keyword">library</span>(highcharter)
<span class="hljs-keyword">library</span>(RColorBrewer)
<span class="hljs-keyword">library</span>(leaflet)
<span class="hljs-keyword">library</span>(rgdal)
<span class="hljs-keyword">library</span>(dygraphs)
<span class="hljs-keyword">library</span>(quantmod)
<span class="hljs-keyword">library</span>(DT)
</code></pre><p>The goal of today’s class is to briefly introduce a range of htmlwidgets. To explore all of their options, you will need to study the detailed documentation for each.</p><h3 id="highcharter"><a name="highcharter" href="#highcharter"></a>Highcharter</h3><h4 id="load-and-process-nations-data-to-calculate-the-total-gdp-per-world-bank-region,-by-year"><a name="load-and-process-nations-data-to-calculate-the-total-gdp-per-world-bank-region,-by-year" href="#load-and-process-nations-data-to-calculate-the-total-gdp-per-world-bank-region,-by-year"></a>Load and process nations data to calculate the total GDP per world bank region, by year</h4><p>This code duplicates one of the examples from <a href="r-analysis.html">yesterday’s NICAR class</a> on data analysis in R. It reads in the World Bank data, calculates the GDP for each country in each year, and then sums the values across World Bank regions for each year.</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># load data
nations &amp;lt;- read_csv(&quot;nations.csv&quot;) 

# process data
gdp_regions &amp;lt;- nations %&amp;gt;%
  mutate(gdp = gdp_percap * population,
         gdp_tn = gdp/1000000000000) %&amp;gt;%
  group_by(region, year) %&amp;gt;%
  summarize(total_gdp_tn = sum(gdp_tn, na.rm = TRUE))
</code></pre>"><span class="hljs-comment"># load data</span>
nations &lt;- read_csv(<span class="hljs-string">"nations.csv"</span>) 

<span class="hljs-comment"># process data</span>
gdp_regions &lt;- nations %&gt;%
  mutate(gdp = gdp_percap * population,
         gdp_tn = gdp/<span class="hljs-number">1000000000000</span>) %&gt;%
  group_by(region, year) %&gt;%
  summarize(total_gdp_tn = sum(gdp_tn, na.rm = <span class="hljs-literal">TRUE</span>))
</code></pre><h4 id="make-a-chart-from-this-data"><a name="make-a-chart-from-this-data" href="#make-a-chart-from-this-data"></a>Make a chart from this data</h4><p>Draw a basic symbol-and-line chart with default settings:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># basic symbol-and-line chart, default settings
highchart() %&amp;gt;%
  hc_add_series_df(data = gdp_regions,
                   type = &quot;line&quot;,
                   x = year,
                   y = total_gdp_tn, 
                   group = region)
</code></pre>"><span class="hljs-comment"># basic symbol-and-line chart, default settings</span>
highchart() %&gt;%
  hc_add_series_df(data = gdp_regions,
                   type = <span class="hljs-string">"line"</span>,
                   x = year,
                   y = total_gdp_tn, 
                   group = region)
</code></pre><p>The following chart should appear in the <code>Viewer</code> panel at bottom right:</p><iframe src="raw_data/gdp_regions_a.html" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0"></iframe><p>In the code above, the function <code>highchart()</code> creates a chart.</p><p>Highcharts works by adding data “series” to a chart, and from R you can add the variables from a data frame all in one go using the <code>hc_add_series_df()</code> function. Inside this function we define the data frame to be used, with <code>data</code>, the <code>type</code> of chart, the variables to be mapped to the <code>x</code> and <code>y</code> axes, and the variable to <code>group</code> the data: Here this draws a separate line for each <code>region</code> in the <code>data</code>.</p><p>Clicking on the legend items allows you to remove or add series from the finished chart.</p><p>See <a href="http://www.highcharts.com/docs/chart-and-series-types/chart-types">here</a> for the chart types available in Highcharts.</p><p>Notice how <strong>highcharter</strong> uses the <code>%&gt;%</code> or pipe operator, also used with <strong>dplyr</strong>.</p><p>Now we’ll customize the basic chart.</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># define color palette
cols &amp;lt;- brewer.pal(7, &quot;Set1&quot;)

highchart() %&amp;gt;%
  hc_add_series_df(data = gdp_regions,
                   type = &quot;line&quot;,
                   x = year,
                   y = total_gdp_tn, 
                   group = region) %&amp;gt;%
  hc_colors(cols) %&amp;gt;%
  hc_xAxis(title = list(text=&quot;Year&quot;)) %&amp;gt;%
  hc_yAxis(title = list(text=&quot;GDP ($ trillion)&quot;)) %&amp;gt;%
  hc_plotOptions(series = list(marker = list(symbol = &quot;circle&quot;)))
</code></pre>"><span class="hljs-comment"># define color palette</span>
cols &lt;- brewer.pal(<span class="hljs-number">7</span>, <span class="hljs-string">"Set1"</span>)

highchart() %&gt;%
  hc_add_series_df(data = gdp_regions,
                   type = <span class="hljs-string">"line"</span>,
                   x = year,
                   y = total_gdp_tn, 
                   group = region) %&gt;%
  hc_colors(cols) %&gt;%
  hc_xAxis(title = list(text=<span class="hljs-string">"Year"</span>)) %&gt;%
  hc_yAxis(title = list(text=<span class="hljs-string">"GDP ($ trillion)"</span>)) %&gt;%
  hc_plotOptions(series = list(marker = list(symbol = <span class="hljs-string">"circle"</span>)))
</code></pre><p>The following chart should appear:</p><iframe src="raw_data/gdp_regions_b.html" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0"></iframe><p>The first line of code sets a palette with seven colors, one for each region, using the “Set1” palette from ColorBrewer. This is fed to the function <code>hc_colors()</code> to use those colors on the chart.</p><p>The code then adds axis labels, and finally uses the <code>hc_plotOptions()</code> function to override the default of using a different symbol for reach series, switching to use circles for every line.</p><h5 id="save-the-chart-as-an-r-object"><a name="save-the-chart-as-an-r-object" href="#save-the-chart-as-an-r-object"></a>Save the chart as an R object</h5><p>You can save you code as an R object using the assignment operator (<code>&lt;-</code>).</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;>gdp_regions_chart &amp;lt;- highchart() %&amp;gt;%
  hc_add_series_df(data = gdp_regions,
                   type = &quot;line&quot;,
                   x = year,
                   y = total_gdp_tn, 
                   group = region) %&amp;gt;%
  hc_colors(cols) %&amp;gt;%
  hc_xAxis(title = list(text=&quot;Year&quot;)) %&amp;gt;%
  hc_yAxis(title = list(text=&quot;GDP ($ trillion)&quot;)) %&amp;gt;%
  hc_plotOptions(series = list(marker = list(symbol = &quot;circle&quot;)))
</code></pre>">gdp_regions_chart &lt;- highchart() %&gt;%
  hc_add_series_df(data = gdp_regions,
                   type = <span class="hljs-string">"line"</span>,
                   x = year,
                   y = total_gdp_tn, 
                   group = region) %&gt;%
  hc_colors(cols) %&gt;%
  hc_xAxis(title = list(text=<span class="hljs-string">"Year"</span>)) %&gt;%
  hc_yAxis(title = list(text=<span class="hljs-string">"GDP ($ trillion)"</span>)) %&gt;%
  hc_plotOptions(series = list(marker = list(symbol = <span class="hljs-string">"circle"</span>)))
</code></pre><p>As object of type <code>highchart</code> should now have appeared in your     <code>Environment</code>.</p><h5 id="export-the-saved-chart-as-a-web-page"><a name="export-the-saved-chart-as-a-web-page" href="#export-the-saved-chart-as-a-web-page"></a>Export the saved chart as a web page</h5><p>The following code uses the <strong>htmlwidgets</strong> package to export the chart as a standalone web page, with supporting assets (JavaScript libraries and CSS files) saved in a folder called <code>src</code>.</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;>saveWidget(gdp_regions_chart, &quot;gdp_regions.html&quot;, selfcontained = FALSE, libdir = &quot;src&quot;, background = &quot;white&quot;)
</code></pre>">saveWidget(gdp_regions_chart, <span class="hljs-string">"gdp_regions.html"</span>, selfcontained = <span class="hljs-literal">FALSE</span>, libdir = <span class="hljs-string">"src"</span>, background = <span class="hljs-string">"white"</span>)
</code></pre><p>Open the saved webpage in a web browser, and see what happens when you change the window size. The chart should be completely responsive, expanding or contracting to fill the available space.</p><p>This means that is can be dropped into another webpage in the same folder using a simple iframe:</p><pre class="css hljs"><code class="CSS" data-origin="<pre><code class=&quot;CSS&quot;>&amp;lt;iframe src=&quot;gdp_regions.html&quot; width=&quot;100%&quot; height=&quot;500&quot; frameborder=&quot;0&quot; marginheight=&quot;0&quot; marginwidth=&quot;0&quot;&amp;gt;&amp;lt;/iframe&amp;gt;
</code></pre>">&lt;iframe src="gdp_regions.html" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0"&gt;&lt;/iframe&gt;
</code></pre><p>Here the iframe is given a constant height of 500px and a width of 100%, allowing for responsive design.</p><h3 id="leaflet"><a name="leaflet" href="#leaflet"></a>Leaflet</h3><p>We are going to recreate a version of <a href="http://paldhous.github.io/earthquakes/">this map</a>, which I originally coded using Leaflet from scratch.</p><p>First let’s see how to make a basic Leaflet map, centered on Jacksonville:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make leaflet map centered on Jacksonville
leaflet() %&amp;gt;%
  setView(lng = -81.65, lat = 30.3, zoom = 11) %&amp;gt;%
  addTiles()
</code></pre>"><span class="hljs-comment"># make leaflet map centered on Jacksonville</span>
leaflet() %&gt;%
  setView(lng = -<span class="hljs-number">81.65</span>, lat = <span class="hljs-number">30.3</span>, zoom = <span class="hljs-number">11</span>) %&gt;%
  addTiles()
</code></pre><iframe src="raw_data/jacksonville_a.html" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0"></iframe><p>The function <code>leaflet()</code> creates a leaflet map; <code>setView()</code> sets the starting position of the map, centering it on the defined coordinates and with the defined zoom level; <code>addTiles()</code> adds <a href="https://www.openstreetmap.org/">OpenStreetMap</a> tiles to the map, which would otherwise be blank. Notice that the map is interactive, and can be panned and zoomed just like a Google Map.</p><p>We aren’t limited to using OpenStreetMap tiles:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make leaflet map centered on Jacksonville with Carto tiles
leaflet() %&amp;gt;%
  setView(lng = -81.65, lat = 30.3, zoom = 11) %&amp;gt;%
  addProviderTiles(&quot;CartoDB.Positron&quot;)
</code></pre>"><span class="hljs-comment"># make leaflet map centered on Jacksonville with Carto tiles</span>
leaflet() %&gt;%
  setView(lng = -<span class="hljs-number">81.65</span>, lat = <span class="hljs-number">30.3</span>, zoom = <span class="hljs-number">11</span>) %&gt;%
  addProviderTiles(<span class="hljs-string">"CartoDB.Positron"</span>)
</code></pre><iframe src="raw_data/jacksonville_b.html" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0"></iframe><p>The function <code>addProviderTiles()</code> uses the <a href="https://github.com/leaflet-extras/leaflet-providers">Leaflet Providers</a> plugin to add various tiles to a map. You can see the available options <a href="http://leaflet-extras.github.io/leaflet-providers/preview/">here</a>.</p><p>Now load the data we need to make the earthquakes map, starting with the <code>seismic_risk</code> shapefile, using the <code>readOGR()</code> function from <strong>rgdal</strong>.</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># load seismic risk shapefile
seismic_risk &amp;lt;- readOGR(&quot;seismic_risk_clip&quot;, &quot;seismic_risk_clip&quot;)
</code></pre>"><span class="hljs-comment"># load seismic risk shapefile</span>
seismic_risk &lt;- readOGR(<span class="hljs-string">"seismic_risk_clip"</span>, <span class="hljs-string">"seismic_risk_clip"</span>)
</code></pre><p>The two mentions of <code>seismic_risk_clip</code> refer to the folder and the shapefile within it, respectively.</p><p>You should now have in your environment an object called <code>seismic_risk</code> which is a <code>SpatialPolygonsDataFrame</code>.</p><p>We can also load data on earthquakes, directly from the U.S. Geological Survey API:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># load quakes data from USGS earthquakes API
quakes &amp;lt;- read_csv(&quot;http://earthquake.usgs.gov/fdsnws/event/1/query?starttime=1965-01-01T00:00:00&amp;amp;minmagnitude=6&amp;amp;format=csv&amp;amp;latitude=39.828175&amp;amp;longitude=-98.5795&amp;amp;maxradiuskm=6000&amp;amp;orderby=magnitude&quot;)
</code></pre>"><span class="hljs-comment"># load quakes data from USGS earthquakes API</span>
quakes &lt;- read_csv(<span class="hljs-string">"http://earthquake.usgs.gov/fdsnws/event/1/query?starttime=1965-01-01T00:00:00&amp;minmagnitude=6&amp;format=csv&amp;latitude=39.828175&amp;longitude=-98.5795&amp;maxradiuskm=6000&amp;orderby=magnitude"</span>)
</code></pre><p>Using this url, we have loaded earthquakes since the start of 1965 that had a magnitude of 6 and above, within a 6,000 kilometer radius of the geographic center of the continental United States.</p><p>Let’s look at a summary of the <code>seismic_risk</code> data</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># view summary of seismic_risk data
summary(seismic_risk)
</code></pre>"><span class="hljs-comment"># view summary of seismic_risk data</span>
summary(seismic_risk)
</code></pre><p>This should be returned in the R Console:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;>Object of class SpatialPolygonsDataFrame
Coordinates:
      min       max
x -124.71 -66.98701
y   24.60  49.36968
Is projected: FALSE 
proj4string :
[+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0]
Data attributes:
    ACC_VAL           VALLEY       
 Min.   :  0.00   Min.   :0.00000  
 1st Qu.: 18.00   1st Qu.:0.00000  
 Median : 40.00   Median :0.00000  
 Mean   : 44.57   Mean   :0.08264  
 3rd Qu.: 60.00   3rd Qu.:0.00000  
 Max.   :200.00   Max.   :1.00000
</code></pre>">Object of class SpatialPolygonsDataFrame
Coordinates:
      min       max
x -<span class="hljs-number">124.71</span> -<span class="hljs-number">66.98701</span>
y   <span class="hljs-number">24.60</span>  <span class="hljs-number">49.36968</span>
Is projected: <span class="hljs-literal">FALSE</span> 
proj4string :
[+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]
Data attributes:
    ACC_VAL           VALLEY       
 Min.   :  <span class="hljs-number">0.00</span>   Min.   :<span class="hljs-number">0.00000</span>  
 1st Qu.: <span class="hljs-number">18.00</span>   1st Qu.:<span class="hljs-number">0.00000</span>  
 Median : <span class="hljs-number">40.00</span>   Median :<span class="hljs-number">0.00000</span>  
 Mean   : <span class="hljs-number">44.57</span>   Mean   :<span class="hljs-number">0.08264</span>  
 3rd Qu.: <span class="hljs-number">60.00</span>   3rd Qu.:<span class="hljs-number">0.00000</span>  
 Max.   :<span class="hljs-number">200.00</span>   Max.   :<span class="hljs-number">1.00000</span>
</code></pre><p>The data defining the risk of a major earthquake is in the variable <code>ACC_VAL</code>, and has values that run from 0 to 200.</p><p>We are going to make a choropleth map, so we will first set breaks to divide the data in into bins:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># set breaks for custom bins
breaks &amp;lt;- c(0,19,39,59,79,200)
</code></pre>"><span class="hljs-comment"># set breaks for custom bins</span>
breaks &lt;- c(<span class="hljs-number">0</span>,<span class="hljs-number">19</span>,<span class="hljs-number">39</span>,<span class="hljs-number">59</span>,<span class="hljs-number">79</span>,<span class="hljs-number">200</span>)
</code></pre><p>Then set a color palette, using these breaks and a “Reds” sequential color scheme from ColorBrewer (which can be called by name in the leaflet package):</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># set palette
binpal &amp;lt;- colorBin(&quot;Reds&quot;, seismic_risk$ACC_VAL, breaks)
</code></pre>"><span class="hljs-comment"># set palette</span>
binpal &lt;- colorBin(<span class="hljs-string">"Reds"</span>, seismic_risk$ACC_VAL, breaks)
</code></pre><p>Now we are ready to make a choropleth map, using the following code:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make choropleth map of seismic risk
leaflet(seismic_risk) %&amp;gt;%
  setView(lng = -98.5795, lat = 39.828175, zoom = 4) %&amp;gt;%
  addProviderTiles(&quot;CartoDB.Positron&quot;) %&amp;gt;% 
  addPolygons(
    stroke = FALSE,
    fillOpacity = 0.7,
    smoothFactor = 0.1,
    color = ~binpal(ACC_VAL)
  )
</code></pre>"><span class="hljs-comment"># make choropleth map of seismic risk</span>
leaflet(seismic_risk) %&gt;%
  setView(lng = -<span class="hljs-number">98.5795</span>, lat = <span class="hljs-number">39.828175</span>, zoom = <span class="hljs-number">4</span>) %&gt;%
  addProviderTiles(<span class="hljs-string">"CartoDB.Positron"</span>) %&gt;% 
  addPolygons(
    stroke = <span class="hljs-literal">FALSE</span>,
    fillOpacity = <span class="hljs-number">0.7</span>,
    smoothFactor = <span class="hljs-number">0.1</span>,
    color = ~binpal(ACC_VAL)
  )
</code></pre><iframe src="raw_data/seismic_a.html" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0"></iframe><p>The function <code>addPolygons()</code> adds polygons to the map: <code>stroke = FALSE</code> gives them no outline; <code>fillOpacity = 0.7</code> makes them slightly transparent; <code>color = ~binpal(ACC_VAL)</code> uses the color palette and breaks we set up earlier to color the polygons according to values in the <code>ACC_VAL</code> data.</p><p><code>smoothFactor</code> controls the extent to which the polygons are simplified. See what happens to the map if you replace <code>0.1</code> with <code>10</code>. Simplified polygons will load more quickly, but there’s a tradeoff with the appearance of the map. Choose an appropriate value for your maps through trial and error.</p><p>We can add circles for the quakes as a second data layer by extending the code as follows:</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make choropleth map of seismic risk
leaflet(seismic_risk) %&amp;gt;%
  setView(lng = -98.5795, lat = 39.828175, zoom = 4) %&amp;gt;%
  addProviderTiles(&quot;CartoDB.Positron&quot;) %&amp;gt;% 
  addPolygons(
    stroke = FALSE, 
    fillOpacity = 0.7, 
    smoothFactor = 0.1,
    color = ~binpal(ACC_VAL)
  ) %&amp;gt;%
  # add historical earthquakes
  addCircles(
    data = quakes, 
    radius = sqrt(10^quakes$mag)*50, 
    color = &quot;#000000&quot;,
    weight = 0.2,
    fillColor =&quot;#ffffff&quot;,
    fillOpacity = 0.3,
    popup = paste0(&quot;&amp;lt;strong&amp;gt;Magnitude: &amp;lt;/strong&amp;gt;&quot;, quakes$mag, &quot;&amp;lt;/br&amp;gt;&quot;,
                   &quot;&amp;lt;strong&amp;gt;Date: &amp;lt;/strong&amp;gt;&quot;, format(as.Date(quakes$time), &quot;%b %d, %Y&quot;))
  )
</code></pre>"><span class="hljs-comment"># make choropleth map of seismic risk</span>
leaflet(seismic_risk) %&gt;%
  setView(lng = -<span class="hljs-number">98.5795</span>, lat = <span class="hljs-number">39.828175</span>, zoom = <span class="hljs-number">4</span>) %&gt;%
  addProviderTiles(<span class="hljs-string">"CartoDB.Positron"</span>) %&gt;% 
  addPolygons(
    stroke = <span class="hljs-literal">FALSE</span>, 
    fillOpacity = <span class="hljs-number">0.7</span>, 
    smoothFactor = <span class="hljs-number">0.1</span>,
    color = ~binpal(ACC_VAL)
  ) %&gt;%
  <span class="hljs-comment"># add historical earthquakes</span>
  addCircles(
    data = quakes, 
    radius = sqrt(<span class="hljs-number">10</span>^quakes$mag)*<span class="hljs-number">50</span>, 
    color = <span class="hljs-string">"#000000"</span>,
    weight = <span class="hljs-number">0.2</span>,
    fillColor =<span class="hljs-string">"#ffffff"</span>,
    fillOpacity = <span class="hljs-number">0.3</span>,
    popup = paste0(<span class="hljs-string">"&lt;strong&gt;Magnitude: &lt;/strong&gt;"</span>, quakes$mag, <span class="hljs-string">"&lt;/br&gt;"</span>,
                   <span class="hljs-string">"&lt;strong&gt;Date: &lt;/strong&gt;"</span>, format(as.Date(quakes$time), <span class="hljs-string">"%b %d, %Y"</span>))
  )
</code></pre><iframe src="raw_data/seismic_b.html" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0"></iframe><p>The <code>addCircles()</code> function adds circles to the map, drawn from the <code>quakes</code> data; <code>color</code> sets the color for their outlines, while <code>weight</code> sets the thickness of these lines; <code>fillColor</code> and <code>fillOpacity</code> style the circles’ interiors.</p><p>The size if the circles is set by <code>radius = sqrt(quakes$mag^10)*50</code>. Here <code>50</code> is simply a scaling factor for all of the circles, set by trial and error to give a reasonable appearance on the map. The size of the circles is set from the variable <code>mag</code> in the quakes data, which is their magnitude. We have raised 10 to the power of these magnitude values: This is a quirk of working with earthquake magnitudes, which are on a logarithmic scale, so that a magnitude difference of 1 corresponds to a 10-fold difference in earth movement, as recorded on a seismogram.</p><p>When scaling circles, use the values from the data, and then take their square roots, using the <code>sqrt()</code> function. This is important, to ensure that the circles are scaled correctly, by area, rather than by radius.</p><p><code>popup</code> is used to define the HTML code the appears in the popup that appears when any quake is clicked or tapped. Here we used the R function <code>paste0()</code> to paste together a series of elements, separated by commas, that will write the HTML. They include the <code>mag</code> and <code>time</code> values from the quakes data, the latter being formatted as an easy-to-read date using R’s <code>format()</code> function for dates. See <a href="http://www.statmethods.net/input/dates.html">here</a> for more on formatting dates in R.</p><p>Having completed our map, we can again save it as an R object, and then save as a webpage.</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># make choropleth map of seismic risk
seismic &amp;lt;- leaflet(seismic_risk) %&amp;gt;%
  setView(lng = -98.5795, lat = 39.828175, zoom = 4) %&amp;gt;%
  addProviderTiles(&quot;CartoDB.Positron&quot;) %&amp;gt;% 
  addPolygons(
    stroke = FALSE, 
    fillOpacity = 0.7, 
    smoothFactor = 0.1,
    color = ~binpal(ACC_VAL)
  ) %&amp;gt;%
  # add historical earthquakes
  addCircles(
    data = quakes, 
    radius = sqrt(10^quakes$mag)*50, 
    color = &quot;#000000&quot;,
    weight = 0.2,
    fillColor =&quot;#ffffff&quot;,
    fillOpacity = 0.3,
    popup = paste0(&quot;&amp;lt;strong&amp;gt;Magnitude: &amp;lt;/strong&amp;gt;&quot;, quakes$mag, &quot;&amp;lt;/br&amp;gt;&quot;,
                   &quot;&amp;lt;strong&amp;gt;Date: &amp;lt;/strong&amp;gt;&quot;, format(as.Date(quakes$time), &quot;%b %d, %Y&quot;))
  )

# save as a web page
saveWidget(seismic, &quot;seismic.html&quot;, selfcontained = FALSE, libdir = &quot;src&quot;, background = &quot;white&quot;)
</code></pre>"><span class="hljs-comment"># make choropleth map of seismic risk</span>
seismic &lt;- leaflet(seismic_risk) %&gt;%
  setView(lng = -<span class="hljs-number">98.5795</span>, lat = <span class="hljs-number">39.828175</span>, zoom = <span class="hljs-number">4</span>) %&gt;%
  addProviderTiles(<span class="hljs-string">"CartoDB.Positron"</span>) %&gt;% 
  addPolygons(
    stroke = <span class="hljs-literal">FALSE</span>, 
    fillOpacity = <span class="hljs-number">0.7</span>, 
    smoothFactor = <span class="hljs-number">0.1</span>,
    color = ~binpal(ACC_VAL)
  ) %&gt;%
  <span class="hljs-comment"># add historical earthquakes</span>
  addCircles(
    data = quakes, 
    radius = sqrt(<span class="hljs-number">10</span>^quakes$mag)*<span class="hljs-number">50</span>, 
    color = <span class="hljs-string">"#000000"</span>,
    weight = <span class="hljs-number">0.2</span>,
    fillColor =<span class="hljs-string">"#ffffff"</span>,
    fillOpacity = <span class="hljs-number">0.3</span>,
    popup = paste0(<span class="hljs-string">"&lt;strong&gt;Magnitude: &lt;/strong&gt;"</span>, quakes$mag, <span class="hljs-string">"&lt;/br&gt;"</span>,
                   <span class="hljs-string">"&lt;strong&gt;Date: &lt;/strong&gt;"</span>, format(as.Date(quakes$time), <span class="hljs-string">"%b %d, %Y"</span>))
  )

<span class="hljs-comment"># save as a web page</span>
saveWidget(seismic, <span class="hljs-string">"seismic.html"</span>, selfcontained = <span class="hljs-literal">FALSE</span>, libdir = <span class="hljs-string">"src"</span>, background = <span class="hljs-string">"white"</span>)
</code></pre><p>One issue with the <strong>leaflet</strong> package is that there is no function to disable scrollwheel zoom, which leads to maps zooming out when scrolling using a touchpad or screen. To prevent this happening, include <a href="./raw_data/src/Leaflet.Sleep.js">this file</a> (<a href="http://cliffcloud.github.io/Leaflet.Sleep/">here</a> is some background from its author) in the <code>src</code> folder, which sleeps the map until hovered or clicked. You will also need to add this line of code between the <code>&lt;head&gt; &lt;/head&gt;</code> tags of the web page:</p><pre class="css hljs"><code class="CSS" data-origin="<pre><code class=&quot;CSS&quot;>&amp;lt;script src=&quot;src/Leaflet.Sleep.js&quot;&amp;gt;&amp;lt;/script&amp;gt;
</code></pre>">&lt;script src="src/Leaflet.Sleep.js"&gt;&lt;/script&gt;
</code></pre><h3 id="dygraphs"><a name="dygraphs" href="#dygraphs"></a>Dygraphs</h3><p>Dygraphs is designed for drawing time series charts, including stock charts. First we will grab historical stock data for three large technology companies using the <strong>quantmod</strong> packahe</p><p>Quantmod returns R <code>xts</code> objects, for “extensible time series.” We’ll combine the adjusted daily closing prices for each company into a single <code>xts</code> object, and then draw a chart.</p><h4 id="load-and-process-the-data"><a name="load-and-process-the-data" href="#load-and-process-the-data"></a>Load and process the data</h4><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># retrieve data for each company
google &amp;lt;- getSymbols(&quot;GOOG&quot;, src = &quot;yahoo&quot;, auto.assign = FALSE)
facebook &amp;lt;- getSymbols(&quot;FB&quot;, src = &quot;yahoo&quot;, auto.assign = FALSE)
amazon &amp;lt;- getSymbols(&quot;AMZN&quot;, src = &quot;yahoo&quot;, auto.assign = FALSE)

# combine adjusted prices into a single xts object
companies &amp;lt;- cbind(google$GOOG.Adjusted, facebook$FB.Adjusted, amazon$AMZN.Adjusted)

# rename the variables, so that they displace nicely in the legend
names(companies) &amp;lt;- c(&quot;Google&quot;,&quot;Facebook&quot;,&quot;Amazon&quot;)
</code></pre>"><span class="hljs-comment"># retrieve data for each company</span>
google &lt;- getSymbols(<span class="hljs-string">"GOOG"</span>, src = <span class="hljs-string">"yahoo"</span>, auto.assign = <span class="hljs-literal">FALSE</span>)
facebook &lt;- getSymbols(<span class="hljs-string">"FB"</span>, src = <span class="hljs-string">"yahoo"</span>, auto.assign = <span class="hljs-literal">FALSE</span>)
amazon &lt;- getSymbols(<span class="hljs-string">"AMZN"</span>, src = <span class="hljs-string">"yahoo"</span>, auto.assign = <span class="hljs-literal">FALSE</span>)

<span class="hljs-comment"># combine adjusted prices into a single xts object</span>
companies &lt;- cbind(google$GOOG.Adjusted, facebook$FB.Adjusted, amazon$AMZN.Adjusted)

<span class="hljs-comment"># rename the variables, so that they displace nicely in the legend</span>
names(companies) &lt;- c(<span class="hljs-string">"Google"</span>,<span class="hljs-string">"Facebook"</span>,<span class="hljs-string">"Amazon"</span>)
</code></pre><h4 id="draw-a-stock-chart"><a name="draw-a-stock-chart" href="#draw-a-stock-chart"></a>Draw a stock chart</h4><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># draw a stock chart
dygraph(companies)
</code></pre>"><span class="hljs-comment"># draw a stock chart</span>
dygraph(companies)
</code></pre><iframe src="raw_data/companies_a.html" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0"></iframe><h4 id="customize-the-chart"><a name="customize-the-chart" href="#customize-the-chart"></a>Customize the chart</h4><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># customize the chart
dygraph(companies, ylab = &quot;Adjusted close&quot;) %&amp;gt;%
  dyOptions(colors = brewer.pal(3, &quot;Set1&quot;)) %&amp;gt;%
  dyRangeSelector() %&amp;gt;%
  dyAxis(&quot;x&quot;, drawGrid = FALSE)
</code></pre>"><span class="hljs-comment"># customize the chart</span>
dygraph(companies, ylab = <span class="hljs-string">"Adjusted close"</span>) %&gt;%
  dyOptions(colors = brewer.pal(<span class="hljs-number">3</span>, <span class="hljs-string">"Set1"</span>)) %&gt;%
  dyRangeSelector() %&gt;%
  dyAxis(<span class="hljs-string">"x"</span>, drawGrid = <span class="hljs-literal">FALSE</span>)
</code></pre><iframe src="raw_data/companies_b.html" width="100%" height="500" frameborder="0" marginheight="0" marginwidth="0"></iframe><p>Colors can be set, here using RColorBrewer, in the <code>dyOptions()</code> function. The <code>dyRangeSelector()</code> function adds the date selector slider control at the bottom of the chart. The <code>dyAxis()</code> function is here configured to turn off vertical grid lines on the chart. The Y axis label is added using <code>ylab</code> in the initial <code>dygraph()</code> function.</p><p>The chart can be saved as an R object and exported as a web page as for the earlier examples.</p><h3 id="dt"><a name="dt" href="#dt"></a>DT</h3><p>Finally we will make a searchable HTML table using the <strong>DT</strong> package.</p><h4 id="process-data"><a name="process-data" href="#process-data"></a>Process data</h4><p>First, we’ll process the <code>nations</code> data to present data on life expectancy for each nation in 2014, sorted from highest to lowest, also showing their region and World Bank income group.</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;># filter data for 2014 only
longevity &amp;lt;- nations %&amp;gt;%
  filter(year == 2014 &amp;amp; !is.na(life_expect)) %&amp;gt;%
  select(country, life_expect, income, region) %&amp;gt;%
  arrange(desc(life_expectancy))

# rename the variables for display in the table
names(longevity) &amp;lt;- c(&quot;Country&quot;,&quot;Income group&quot;,&quot;Region&quot;,&quot;Life expectancy&quot;)
</code></pre>"><span class="hljs-comment"># filter data for 2014 only</span>
longevity &lt;- nations %&gt;%
  filter(year == <span class="hljs-number">2014</span> &amp; !is.na(life_expect)) %&gt;%
  select(country, life_expect, income, region) %&gt;%
  arrange(desc(life_expect))

<span class="hljs-comment"># rename the variables for display in the table</span>
names(longevity) &lt;- c(<span class="hljs-string">"Country"</span>,<span class="hljs-string">"Income group"</span>,<span class="hljs-string">"Region"</span>,<span class="hljs-string">"Life expectancy"</span>)
</code></pre><h4 id="make-a-table"><a name="make-a-table" href="#make-a-table"></a>Make a table</h4><p>This is as simple as running the function <code>datatable()</code> on the <code>longevity</code> data.</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;>datatable(longevity)
</code></pre>">datatable(longevity)
</code></pre><iframe src="raw_data/longevity_a.html" width="100%" height="580" frameborder="0" marginheight="0" marginwidth="0"></iframe><p>The table can be sorted by clicking on the column headers, and searched using the search box.</p><h4 id="customize-the-table"><a name="customize-the-table" href="#customize-the-table"></a>Customize the table</h4><p>The table easily can be customized.</p><pre class="r hljs"><code class="R" data-origin="<pre><code class=&quot;R&quot;>datatable(longevity,  
          rownames = FALSE) %&amp;gt;% 
          formatStyle(&quot;Life expectancy&quot;,
                      color = &quot;red&quot;,
                      fontWeight = &quot;bold&quot;)
</code></pre>">datatable(longevity,  
          rownames = <span class="hljs-literal">FALSE</span>) %&gt;% 
          formatStyle(<span class="hljs-string">"Life expectancy"</span>,
                      color = <span class="hljs-string">"red"</span>,
                      fontWeight = <span class="hljs-string">"bold"</span>)
</code></pre><iframe src="raw_data/longevity_b.html" width="100%" height="580" frameborder="0" marginheight="0" marginwidth="0"></iframe><p>Setting <code>rownames</code> to false in the <code>datatables()</code> function removes the numbering of the rows in the table. The <code>formatStyle</code> here sets the font color and weight for the <code>Life Expectancy</code> column.</p><h3 id="next-steps"><a name="next-steps" href="#next-steps"></a>Next steps</h3><p>These examples illustrate the potential of <strong>htmlwidgets</strong>. There are many more which we have not covered. Understanding how the code for each works and can be customized will take some time. But if you follow the documentation, the results can be impressive.</p><h3 id="further-reading/resources"><a name="further-reading/resources" href="#further-reading/resources"></a>Further reading/resources</h3><p><strong><a href="http://www.htmlwidgets.org/showcase_leaflet.html">htmlwidgets Showcase</a></strong><br>Links to documentation and code examples for the leading htmlwidgets.</p><p><strong><a href="http://gallery.htmlwidgets.org/">htmlwidgets Gallery</a></strong><br>A more extensive collection of htmlwidgets</p>

	</div> <!-- /.container all -->

	<script src="http://code.jquery.com/jquery.min.js"></script>
	<script src="../js/bootstrap.min.js"></script>

</body>
</html>
